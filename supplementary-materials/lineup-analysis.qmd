---
title: "Lineup Analysis"
format: html
editor: source
embed-resources: true
code-fold: true
execute: 
  echo: true
  message: false
  warning: false
---


```{r setup}
#| include: false
library(tidyverse)
library(cowplot)
library(digest)
library(patchwork)

library(readr)

library(lme4)
library(emmeans)
```

# Data

```{r, eval = T}
lineup_model_data <- read_csv("lineup-model-data.csv") |> 
  mutate(conf_level = factor(conf_level, levels = c("Very Certain", "Certain", "Neutral", "Uncertain", "Very Uncertain"))) |> 
  mutate(conf_level_num = as.numeric(conf_level))
```

```{r}
lineup_model_data |> 
  select(participant_id, age, gender, academic_study, dataset_id, curvature, scale, correct, response_no, binary_response, conf_level, choice_reason) |> 
  head() |> 
  knitr::kable()
```

# Visual of Observed Results

+ There are `r length(unique(lineup_model_data$participant_id)) %>% as.numeric` participants and `r nrow(lineup_model_data) %>% as.numeric()` lineups complete. 
<!-- + Each plot was evaluated between ` min(ploteval_summary$count) %>% as.numeric() %>% round(2)` and ` max(ploteval_summary$count)  %>% as.numeric()  %>% round(2)` times (Mean: ` mean(ploteval_summary$count)  %>% as.numeric()  %>% round(2)`, SD: ` sd(ploteval_summary$count)  %>% as.numeric()  %>% round(2)`). -->
+ Participants correctly identified the target panel in `r round(as.numeric(mean(lineup_model_data$binary_response[lineup_model_data$scale == 'linear']))*100, 2)`% of the `r nrow(lineup_model_data[lineup_model_data$scale == 'linear',]) %>% as.numeric()` lineup evaulations made on the linear scale and `r round(as.numeric(mean(lineup_model_data$binary_response[lineup_model_data$scale == 'log']))*100, 2)`% of the `r nrow(lineup_model_data[lineup_model_data$scale == 'log',]) %>% as.numeric()` lineup evaluations made on the log scale.

```{r}
scale_level <- c("linear" = "Linear Scale",
                 "log" = "Log Scale")

curvature_order <- c("t-E_n-H",
                     "t-H_n-E",
                     "t-M_n-H",
                     "t-H_n-M",
                     "t-E_n-M",
                     "t-M_n-E"
                     )

accuracy_plot_linear <- lineup_model_data |> 
  filter(scale == "linear") |> 
  mutate(target = factor(target, levels = c("H", "M", "E")),
         null = factor(null, levels = c("H", "M", "E")),
         curvature = factor(curvature, levels = curvature_order)
         ) |> 
  ggplot(aes(x = curvature,
             fill = as.factor(binary_response))) +
  geom_bar(stat = "count",
           position = "fill") +
  # facet_wrap(~scale, 
  #            ncol = 1,
  #            labeller = labeller(scale = scale_level)
  #            ) +
  scale_fill_manual(values = c("darkgray", "#008b00"), label = c("Incorrect", "Correct")) +
  scale_y_continuous(label = scales::percent) +
  scale_x_discrete(labels = c("Target: High\nNull: Low",
                              "Target: Low \nNull: High",
                              "Target: Medium \nNull: Low",
                              "Target: Low \nNull: Medium",
                              "Target: High \nNull: Medium",
                              "Target: Medium \nNull: High"),
                   position = "top") +
  labs(y = "",
       x = "",
       fill = "Target Panel \nIdentification",
       subtitle = "Linear Scale",
       title = str_c("Proportion of Participants who ", "<span style = 'color:#008b00'>**correctly**</span>", " and ", 
       "<span style = 'color:#808080'>**incorrectly**</span>", " identified the target panel")) +
  theme_test() +
  theme(axis.ticks.x = element_blank(),
        plot.title = ggtext::element_markdown(size = 14),
        legend.position = "none")

picsList <- paste0("../images/", str_remove_all(curvature_order, "-"), "_linear.png")

pimageLinear <- axis_canvas(accuracy_plot_linear, axis = 'x') + 
  draw_image(picsList[1], x = 0.5, scale = 0.6) +
  draw_image(picsList[2], x = 1.5, scale = 0.6) +
  draw_image(picsList[3], x = 2.5, scale = 0.6) +
  draw_image(picsList[4], x = 3.5, scale = 0.6) +
  draw_image(picsList[5], x = 4.5, scale = 0.6) +
  draw_image(picsList[6], x = 5.5, scale = 0.6)

# insert the image strip into the plot
# linear_accuracy <- ggdraw(insert_xaxis_grob(accuracy_plot_linear, pimage, position = "bottom", clip = "on"))

accuracy_plot_linear / pimageLinear

```

```{r}
accuracy_plot_log <- lineup_model_data |> 
  filter(scale == "log") |> 
  mutate(target = factor(target, levels = c("H", "M", "E")),
         null = factor(null, levels = c("H", "M", "E")),
         curvature = factor(curvature, levels = curvature_order)
         ) |> 
  ggplot(aes(x = curvature,
             fill = as.factor(binary_response))) +
  geom_bar(stat = "count",
           position = "fill") +
  # facet_wrap(~scale, 
  #            ncol = 1,
  #            labeller = labeller(scale = scale_level)
  #            ) +
  scale_fill_manual(values = c("darkgray", "#008b00"), label = c("Incorrect", "Correct")) +
  scale_y_continuous(label = scales::percent) +
  scale_x_discrete(labels = c("Target: High\nNull: Low",
                              "Target: Low \nNull: High",
                              "Target: Medium \nNull: Low",
                              "Target: Low \nNull: Medium",
                              "Target: High \nNull: Medium",
                              "Target: Medium \nNull: High")) +
  labs(y = "",
       x = "",
       fill = "Target Panel \nIdentification",
       subtitle = "Log Scale") +
  theme_test() +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "none")

accuracy_plot_log

picsListLog <- paste0("../images/", str_remove_all(curvature_order, "-"), "_log.png")

pimageLog <- axis_canvas(accuracy_plot_log, axis = 'x') + 
  draw_image(picsListLog[1], x = 0.5, scale = 0.6) +
  draw_image(picsListLog[2], x = 1.5, scale = 0.6) +
  draw_image(picsListLog[3], x = 2.5, scale = 0.6) +
  draw_image(picsListLog[4], x = 3.5, scale = 0.6) +
  draw_image(picsListLog[5], x = 4.5, scale = 0.6) +
  draw_image(picsListLog[6], x = 5.5, scale = 0.6)

pimageLog/
accuracy_plot_log

# insert the image strip into the plot
log_accuracy <- ggdraw(insert_xaxis_grob(accuracy_plot_log, pimage, position = "bottom", clip = "on"))
```

```{r}
linear_accuracy / log_accuracy
```

```{r}
accuracy_plot_linear / pimageLinear / pimageLinear / accuracy_plot_log
```

```{r}
simData <- read.csv("../data/difficulty-comparison-data.csv")

tE_nM <- simData  |>
  mutate(Target = "High",
         Null = "Medium") |>
  filter(curvature %in% c("E", "M")) |>
  mutate(curvature = factor(curvature, levels = c("E", "M", "H"))) |>
  ggplot(aes(x = x, y = y, color = curvature, linetype = curvature)) +
  geom_line(linewidth = 1) +
  theme_test() +
  theme(aspect.ratio = 1) +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        legend.position = "none") +
  scale_x_continuous(limits = c(0,20)) +
  scale_color_manual(values = c("green3", "black")) +
  scale_linetype_manual(values = c("solid", "dashed"))

tE_nH <- simData  |>
  mutate(Target = "High",
         Null = "Low") |>
  filter(curvature %in% c("E", "H")) |>
  mutate(curvature = factor(curvature, levels = c("E", "M", "H"))) |>
  ggplot(aes(x = x, y = y, color = curvature, linetype = curvature)) +
  geom_line(linewidth = 1) +
  theme_test() +
  theme(aspect.ratio = 1) +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        legend.position = "none") +
  scale_x_continuous(limits = c(0,20)) +
  scale_color_manual(values = c("green3", "black")) +
  scale_linetype_manual(values = c("solid", "dashed"))

tM_nE <- simData  |>
  mutate(Target = "Medium",
         Null = "High") |>
  filter(curvature %in% c("E", "M")) |>
  mutate(curvature = factor(curvature, levels = c("E", "M", "H"))) |>
  ggplot(aes(x = x, y = y, color = curvature, linetype = curvature)) +
  geom_line(linewidth = 1) +
  theme_test() +
  theme(aspect.ratio = 1) +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        legend.position = "none") +
  scale_x_continuous(limits = c(0,20)) +
  scale_color_manual(values = c("black", "green3")) +
  scale_linetype_manual(values = c("dashed", "solid"))

tM_nH <- simData  |>
  mutate(Target = "Medium",
         Null = "Low") |>
  filter(curvature %in% c("H", "M")) |>
  mutate(curvature = factor(curvature, levels = c("E", "M", "H"))) |>
  ggplot(aes(x = x, y = y, color = curvature, linetype = curvature)) +
  geom_line(linewidth = 1) +
  theme_test() +
  theme(aspect.ratio = 1) +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        legend.position = "none") +
  scale_x_continuous(limits = c(0,20)) +
  scale_color_manual(values = c("green3", "black")) +
  scale_linetype_manual(values = c("solid", "dashed"))

tH_nE <- simData  |>
  mutate(Target = "Low",
         Null = "High") |>
  filter(curvature %in% c("E", "H")) |>
  mutate(curvature = factor(curvature, levels = c("E", "M", "H"))) |>
  ggplot(aes(x = x, y = y, color = curvature, linetype = curvature)) +
  geom_line(linewidth = 1) +
  theme_test() +
  theme(aspect.ratio = 1) +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        legend.position = "none") +
  scale_x_continuous(limits = c(0,20)) +
  scale_color_manual(values = c("black", "green3")) +
  scale_linetype_manual(values = c("dashed", "solid"))

tH_nM <- simData  |>
  mutate(Target = "Low",
         Null = "Medium") |>
  filter(curvature %in% c("H", "M")) |>
  mutate(curvature = factor(curvature, levels = c("E", "M", "H"))) |>
  ggplot(aes(x = x, y = y, color = curvature, linetype = curvature)) +
  geom_line(linewidth = 1) +
  theme_test() +
  theme(aspect.ratio = 1) +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        legend.position = "none") +
  scale_x_continuous(limits = c(0,20)) +
  scale_color_manual(values = c("black", "green3")) +
  scale_linetype_manual(values = c("dashed", "solid"))

# linear scale

tE_nH_linear <- tE_nH +
  scale_y_continuous(limits = c(10,100))

tE_nM_linear <- tE_nM +
  scale_y_continuous(limits = c(10,100))

tM_nH_linear <- tM_nH +
  scale_y_continuous(limits = c(10,100))

tM_nE_linear <- tM_nE +
  scale_y_continuous(limits = c(10,100))

tH_nM_linear <- tH_nM +
  scale_y_continuous(limits = c(10,100))

tH_nE_linear <- tH_nE +
  scale_y_continuous(limits = c(10,100))

# log scale

library(scales)

tE_nH_log <- tE_nH +
  scale_y_continuous(limits = c(10,100), trans = "log10")

tE_nM_log <- tE_nM +
  scale_y_continuous(limits = c(10,100), trans = "log10")

tM_nH_log <- tM_nH +
  scale_y_continuous(limits = c(10,100), trans = "log10")

tM_nE_log <- tM_nE +
  scale_y_continuous(limits = c(10,100), trans = "log10")

tH_nM_log <- tH_nM +
  scale_y_continuous(limits = c(10,100), trans = "log10")

tH_nE_log <- tH_nE +
  scale_y_continuous(limits = c(10,100), trans = "log10")



curvature_order <- c("t-E_n-H",
                     "t-H_n-E",
                     "t-M_n-H",
                     "t-H_n-M",
                     "t-E_n-M",
                     "t-M_n-E"
                     )

# output plots with patchwork
linear_thumbnails <- tE_nH_linear +
  tH_nE_linear +
  tM_nH_linear +
  tH_nM_linear +
  tE_nM_linear +
  tM_nE_linear +
  plot_layout(ncol = 6)

linear_thumbnails



log_thumbnails <- tE_nH_log +
  tH_nE_log +
  tM_nH_log +
  tH_nM_log +
  tE_nM_log +
  tM_nE_log +
  plot_layout(ncol = 6)

log_thumbnails
```

```{r}
linear_plot <- (accuracy_plot_linear / 
  (tE_nH_linear +
  tH_nE_linear +
  tM_nH_linear +
  tH_nM_linear +
  tE_nM_linear +
  tM_nE_linear +
  plot_layout(ncol = 6)))
  
  
log_plot <- ((tE_nH_log +
  tH_nE_log +
  tM_nH_log +
  tH_nM_log +
  tE_nM_log +
  tM_nE_log +
  plot_layout(ncol = 6)) /
  accuracy_plot_log)

linear_plot
log_plot
```

```{r}
target_levels = tibble(target = c("E", "M", "H"))
null_levels = tibble(null = c("E", "M", "H"))
poo <- simData |> 
  left_join(target_levels, by = c("curvature" = "target")) |> 
  left_join(null_levels, by = c("curvature" = "null"))
```

# Analysis

Target plot identification was analyzed using the `glmer` function in the `lme4` R package. 
Estimates and odds ratio comparisons between the log and linear scales were calculated using the `emmeans` R package.
Each lineup plot evaluated was assigned a value based on the participant response (correct = 1, not correct = 0).
Define $Y_{ijkl}$ to be the event that participant $l = 1,...,N_{participant}$ correctly identifies the target plot for data set $k = 1,2$ with curvature combination $j = 1,2,3,4,5,6$ plotted on scale $i = 1,2$.
The binary response was analyzed using a generalized linear mixed model following a binomial distribution with a logit link function with a row-column blocking design accounting for the variation due to participant and data set respectively as 
\begin{equation}
\text{logit }P(Y_{ijk}) = \eta + \delta_i + \gamma_j + \delta \gamma_{ij} + s_l + d_k
\end{equation}
\noindent where

+ $\eta$ is the baseline average probability of selecting the target plot
+ $\delta_i$ is the effect of scale $i = 1,2$
+ $\gamma_j$ is the effect of curvature combination $j = 1,2,3,4,5,6$
+ $\delta\gamma_{ij}$ is the two-way interaction between the $i^{th}$ scale and $j^{th}$ curvature combination
+ $s_l \sim N(0,\sigma^2_\text{participant})$is the random effect for participant characteristics
+ $d_k \sim N(0,\sigma^2_{\text{data}})$ is the random effect for data specific characteristics. 

\noindent We assume that random effects for data set and participant are independent.

```{r}
glmm_mod <- glmer(binary_response ~ curvature*scale + 
                            (1 | participant_id) +
                            (1 | dataset_id),
                  data = lineup_model_data,
                  family = binomial(link = "logit"))

lineup_anova <- car::Anova(glmm_mod) |> 
  broom::tidy()
# summary(glmm_mod)

lineup_anova |> 
  knitr::kable(digits = 3, caption = "Lineups GLMM ANOVA")
```

```{r, eval = F, include = F, fig.align = 'center', fig.width = 12, fig.height = 6}
lineup_lsmeans <- emmeans(glmm_mod, specs = ~ "curvature:scale", type = "response") |> 
  as_tibble()

lineup_lsmeans |> 
  mutate(curvature = factor(curvature, levels = c("t-E_n-H", "t-H_n-E", "t-E_n-M", "t-M_n-E", "t-M_n-H", "t-H_n-M"))) %>%
  ggplot(aes(x = curvature, y = prob, group = scale)) +
  geom_bar(stat = "identity", fill = "lightgray") +
  # geom_text(aes(y = asymp.UCL + 0.05)) +
  facet_wrap(~scale, ncol = 1) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.1) +
  theme_bw() +
  scale_y_continuous("Probability of target panel detected", limit = c(-0.05,1.1), breaks = seq(0,1,0.2)) +
  scale_x_discrete("Curvature")
```


```{r, fig.align = 'center', fig.width = 12, fig.height = 6}
lineups_or <- emmeans(glmm_mod, ~ scale | curvature, type = "response") |> 
  pairs(reverse = T, infer = c(T,T)) |> 
  as_tibble()

# write.csv(lineups_or, here("analyses/01-lineups/results/lineups-odds-ratios.csv"), row.names = F, na =)

dodge <- position_dodge(width=0.9)
lineups_or_plot <- lineups_or %>%
  separate(curvature, into = c(NA, "target", NA, "null")) %>%
  mutate(null = factor(null, levels = c("E", "M", "H"), labels = c("High Curvature", "Medium Curvature", "Low Curvature")),
         target = factor(target, levels = c("E", "M", "H"), labels = c("High Curvature", "Medium Curvature", "Low Curvature"))) %>%
  ggplot(aes(x = odds.ratio, y = null, color = target, shape = target)) + 
  geom_point(position = dodge, size = 3) + 
  geom_errorbar(aes(xmin = asymp.LCL, xmax = asymp.UCL), position = dodge, width = .1) +
  geom_vline(xintercept = 1) +
  theme_bw()  +
  theme(axis.title = element_text(size = 12),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.text  = element_text(size = 12),
        legend.key.size = unit(1, "line"),
        legend.position = "bottom"
  ) +
  scale_y_discrete("Null Panel Difficulty", position = "left") +
  scale_x_continuous("Odds ratio (on log scale) \n (Log vs Linear)", trans = "log10", labels = scales::comma) + 
  scale_color_manual("Target Panel Difficulty", values = c("#004400", "#116611", "#55aa55")) + 
  scale_shape_discrete("Target Panel Difficulty")

lineups_or_plot
```

# Confidence Level Analysis

```{r}
#| fig-width: 12
#| fig-height: 8
# labellers for plotting
target_level <- c(
  "H" = "Low Target Curvature",
  "M" = "Moderate Target Curvature",
  "E" = "High Target Curvature"
)

null_level <- c(
  "H" = "Low Null Curvature",
  "M" = "Moderate Null Curvature",
  "E" = "High Null Curvature"
)

scale_level <- c("linear" = "Linear Scale",
                 "log" = "Log Scale")

lineup_model_data |> 
  mutate(target = factor(target, levels = c("H", "M", "E")),
         null = factor(null, levels = c("H", "M", "E")),
         conf_level = factor(conf_level, levels = c("Very Uncertain", "Uncertain", "Neutral", "Certain", "Very Certain")),
         binary_response = factor(binary_response, levels = c(1,0), labels = c("Correct", "Incorrect"))
         ) |>
  ggplot() +
  geom_mosaic(aes(x = product(binary_response),
             fill = conf_level),
             show.legend = T,
             color = "black") +
  facet_nested(null ~ scale + target,
               # labeller = label_both
             labeller = labeller(scale = scale_level,
                                 null = null_level,
                                 target = target_level)
             ) +
  scale_fill_brewer(palette = "PuOr",
                    guide = guide_legend(reverse = TRUE)) +
  labs(y = "",
       x = "Evaluation",
       fill = "How certain are you?") +
  theme_test() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```

Assuming Normality...

```{r}
# normal
conf_level_num_mod <- lmer(conf_level_num ~ curvature*scale*binary_response + 
                            (1 | participant_id) +
                            (1 | dataset_id),
                  data = lineup_model_data)

car::Anova(conf_level_num_mod) |> 
  broom::tidy()
# summary(conf_level_num_mod)

emmeans(conf_level_num_mod, specs = ~ binary_response | curvature:scale) |> 
  pairs() |> 
  as_tibble() |> 
  mutate(p.value = scales::pvalue(p.value))

emmeans(conf_level_num_mod, specs = ~ scale | curvature:binary_response) |> 
  pairs() |> 
  as_tibble() |> 
  mutate(p.value = scales::pvalue(p.value))

emmeans(conf_level_num_mod, specs = ~ scale | binary_response) |> 
  pairs() |> 
  as_tibble() |> 
  mutate(p.value = scales::pvalue(p.value))
```

assuming multinomial...

```{r}
# nnet
conf_level_mod <- nnet::multinom(conf_level ~ curvature*scale*binary_response, #+ 
                            # (1 | participant_id) +
                            # (1 | dataset_id),
                  data = lineup_model_data,
                  trace = F)

car::Anova(conf_level_mod) |> 
  broom::tidy()
# summary(conf_level_mod)

# emmeans(conf_level_mod, specs = ~ binary_response | curvature:scale, type = "response") |> 
#   pairs() |> 
#   as_tibble() |> 
#   mutate(p.value = scales::pvalue(p.value))
# 
# emmeans(conf_level_mod, specs = ~ scale | curvature:binary_response, type = "response") |> 
#   pairs() |> 
#   as_tibble() |> 
#   mutate(p.value = scales::pvalue(p.value))
# 
# emmeans(conf_level_mod, specs = ~ scale | binary_response, type = "response") |> 
#   pairs() |> 
#   as_tibble() |> 
#   mutate(p.value = scales::pvalue(p.value))

# mlogit
# conf_level_mod2 <- mlogit::mlogit(conf_level ~ curvature*scale + 
#                             (1 | participant_id) +
#                             (1 | dataset_id),
#                   data = lineup_model_data)
# 
# car::Anova(conf_level_mod2) |> 
#   broom::tidy()
# summary(conf_level_mod2)
```

# Rorschach lineups

<https://www.researchgate.net/profile/Susan-Vanderplas/publication/347178077_Statistical_Significance_Calculations_for_Scenarios_in_Visual_Inference/links/600598fe45851553a0522f65/Statistical-Significance-Calculations-for-Scenarios-in-Visual-Inference.pdf?_sg%5B0%5D=started_experiment_milestone&origin=journalDetail>

```{r}
lineup_rorschach_data <- read_csv("lineup-rorschach-data.csv") |> 
  mutate(conf_level = factor(conf_level, levels = c("Very Certain", "Certain", "Neutral", "Uncertain", "Very Uncertain"))) |> 
  mutate(conf_level_num = as.numeric(conf_level))
lineup_rorschach_data
```

```{r}
# unique(lineup_rorschach_data$dataset_id) |> length()
target_level <- c(
  "H" = "Low Target Curvature",
  "M" = "Moderate Target Curvature",
  "E" = "High Target Curvature"
)

lineup_rorschach_data |> 
  mutate(target = fct_relevel(target,
                              c("H", "M", "E"))) |> 
  ggplot(aes(x = as.factor(dataset_id),
             fill = as.factor(binary_response))) +
  geom_bar(stat = "count",
           position = "stack") +
  facet_grid(scale ~ target, 
             scales = "free_x",
             labeller = labeller(target = target_level)
             ) +
  theme_bw() +
  scale_fill_manual(values = c("gray", "steelblue"),
                    labels = c("Incorrect", "Correct")) +
  theme(axis.text.x = element_text(angle = -90)) +
  labs(x = "Data Set ID",
       y = "Number of Participants",
       fill = "Identification")

lineup_rorschach_data |> 
  count(target)

lineup_rorschach_data |> 
  count(target, dataset_id)

lineup_rorschach_data |> 
  count()
```
